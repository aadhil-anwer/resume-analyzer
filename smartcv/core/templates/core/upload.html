{% extends "base.html" %}
{% block title %}Upload & Analyze Resume ‚Ä¢ Resume Rater{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Page Header -->
  <div class="text-center mb-4">
    <h2 id="typing-title" class="typing-text"></h2>
    <p class="subtitle text-muted">
      Upload your resume and let AI craft a LaTeX version that's calm, precise, and unforgettable.
    </p>
  </div>

  <!-- Upload Card -->
  <div class="upload-card mx-auto">
    <form action="{% url 'upload_resume' %}" method="post" enctype="multipart/form-data" id="upload-form">
      {% csrf_token %}
      <div class="mb-3">
        <label for="resume" class="file-label" id="file-label">üìÑ Choose your resume</label>
        <input id="resume" type="file" name="resume" accept=".pdf,.docx" required hidden>
        <div id="file-name" class="file-name mt-2 text-muted">No file chosen</div>
      </div>

      <button type="submit" class="btn btn-primary">Upload & Analyze</button>
    </form>
  </div>

  {% if error %}
    <div class="alert alert-danger mt-4 text-center">{{ error }}</div>
  {% endif %}

  <!-- Hidden raw server result -->
  <textarea id="raw-result" hidden>{{ result|default_if_none:""|escape }}</textarea>

  <!-- Generate LaTeX form -->
  <div id="generate-wrapper" class="text-center mt-3" style="display:none;">
    <form action="{% url 'generate_latex' %}" method="post" id="latex-form">
      {% csrf_token %}
      <input type="hidden" name="resume_text" id="resume_text_input" value="">
      <button type="submit" class="btn btn-success">Generate LaTeX Resume</button>
    </form>
  </div>

  <!-- Placeholder for analysis results -->
  <div id="analysis-root" class="mt-5"></div>

  {% if pdf_data_uri %}
  <div class="report-container mt-5">
    <h3 class="text-center gradient-text">Your Generated LaTeX Resume</h3>
    <iframe src="{{ pdf_data_uri }}"></iframe>
    <div class="text-center mt-3">
      <a href="{{ pdf_data_uri }}" download="resume.pdf" class="btn btn-success">‚¨áÔ∏è Download PDF</a>
    </div>
  </div>
  {% endif %}
</div>

<!-- Floating Notification -->
<div class="analysis-notification" id="analysis-notification">
  <div class="notification-content">
    <div class="notification-icon">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10
                 10-4.48 10-10S17.52 2 12 2z" fill="white"/>
        <path d="M10 14.59L16.59 8L18 9.41L10 17.41
                 L6 13.41L7.41 12L10 14.59Z" fill="white"/>
      </svg>
    </div>
    <div class="notification-text">
      <h5 id="notification-title">Analyzing Your Resume</h5>
      <p id="notification-message">This may take a few moments...</p>
    </div>
  </div>
  <div class="notification-progress">
    <div class="notification-progress-bar" id="notification-progress-bar"></div>
  </div>
  <div class="loading-dots"><span></span><span></span><span></span></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* Typing Animation */
  const titleText = "Focus on What Matters";
  const titleEl = document.getElementById("typing-title");
  let i = 0;
  (function type() {
    if (i < titleText.length) {
      titleEl.textContent += titleText.charAt(i++);
      setTimeout(type, 80);
    } else titleEl.style.borderRight = "none";
  })();

  /* File input logic */
  const fileInput = document.getElementById("resume");
  const fileLabel = document.getElementById("file-label");
  const fileName = document.getElementById("file-name");
  fileLabel.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", e => fileName.textContent = e.target.files[0]?.name || "No file chosen");

  /* Show/Hide notifications */
  function showNotification(title, msg) {
    document.getElementById("notification-title").textContent = title;
    document.getElementById("notification-message").textContent = msg;
    const n = document.getElementById("analysis-notification");
    n.style.display = "block";
    setTimeout(() => n.classList.add("show"), 50);
  }
  function hideNotification() {
    const n = document.getElementById("analysis-notification");
    n.classList.remove("show");
    setTimeout(() => n.style.display = "none", 400);
  }

  /* Upload form progress simulation */
  document.getElementById("upload-form").addEventListener("submit", () => {
    showNotification("Uploading Resume", "Processing your file...");
  });

  /* Parse server result (if any) */
  const raw = document.getElementById("raw-result").value.trim();
  if (raw) {
    try {
      const data = JSON.parse(raw.replaceAll("&quot;", '"'));
      if (data.status === "PROCESSING") {
        pollStatus(data.resume_id);
      } else {
        renderResult(data);
      }
    } catch(e) { console.warn("No JSON result found."); }
  }

  /* Poll job status */
  function pollStatus(resumeId) {
    showNotification("Analyzing Resume", "This may take a few moments...");
    const progress = document.getElementById("notification-progress-bar");
    let pct = 0;
    const interval = setInterval(() => {
      pct += Math.random() * 10;
      if (pct > 90) pct = 90;
      progress.style.width = pct + "%";
    }, 800);

    const poll = async () => {
      try {
        const res = await fetch(`/check-status/${resumeId}/`);
        const data = await res.json();
        if (data.status && data.status !== "PROCESSING") {
          clearInterval(interval);
          progress.style.width = "100%";
          renderResult(data);
          hideNotification();
        } else {
          setTimeout(poll, 4000);
        }
      } catch (err) {
        console.error(err);
        setTimeout(poll, 5000);
      }
    };
    poll();
  }

  /* Render AI analysis results */
  function renderResult(parsed) {
    const root = document.getElementById("analysis-root");
    root.innerHTML = "";
    if (!parsed || !parsed.ai_analysis) {
      root.innerHTML = "<div class='alert alert-warning'>‚ö†Ô∏è No analysis available.</div>";
      return;
    }
    const ai = parsed.ai_analysis;
    const score = ai.ats_score || 0;
    const color = score >= 80 ? "#22c55e" : score >= 60 ? "#facc15" : "#ef4444";

    root.innerHTML = `
      <div class="report-container text-center">
        <svg width="120" height="120" viewBox="0 0 120 120" style="margin-bottom:1rem;">
          <circle cx="60" cy="60" r="54" stroke="#2a2a2a" stroke-width="10" fill="none"/>
          <circle cx="60" cy="60" r="54" stroke="${color}" stroke-width="10"
            fill="none" stroke-dasharray="339.292" stroke-dashoffset="${339.292 - 339.292 * (score / 100)}"
            style="transition: stroke-dashoffset 1s ease;" />
          <text x="50%" y="55%" text-anchor="middle" fill="white" font-size="22" dy=".3em">${score}%</text>
        </svg>
        <h5 class="text-muted">ATS Score</h5>
        <div class="section"><h4>üìù Grammar</h4><p>${ai.grammar_feedback || "No feedback provided."}</p></div>
        <div class="section"><h4>‚ö° Impact</h4><p>${ai.impact_feedback || "No feedback provided."}</p></div>
        <div class="section"><h4>üéôÔ∏è Tone</h4><p>${ai.tone_feedback || "No feedback provided."}</p></div>
        <div class="section highlight"><h4>üí° Recommendations</h4><p>${ai.overall_recommendations || "No feedback provided."}</p></div>
      </div>
    `;

    // Reveal LaTeX button
    const genWrap = document.getElementById("generate-wrapper");
    const resumeTextInput = document.getElementById("resume_text_input");
    genWrap.style.display = "block";
    resumeTextInput.value = JSON.stringify(parsed);
  }

});
</script>
{% endblock %}
